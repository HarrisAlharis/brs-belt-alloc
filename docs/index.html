<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>BRS Belt Allocations</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Basic, readable styling -->
  <style>
    :root{
      --bg:#0b1220; --panel:#111a2b; --muted:#9aa3af;
      --text:#e5e7eb; --grid:#1c2944; --ok-bg:#12381f; --ok-br:#236b3d; --ok-fg:#c7f3d4;
      --warn-bg:#3a2b10; --warn-br:#825f1a; --warn-fg:#ffd37a;
      --danger-bg:#3a0e10; --danger-br:#7a1b24; --danger-fg:#ffb3b8;
      --badge-bg:#22314f; --badge-br:#3c4a6a; --badge-fg:#e5e7eb;
      --accent:#7aa2ff;
    }
    html,body{background:var(--bg); color:var(--text); margin:0; font:14px/1.45 system-ui,Segoe UI,Roboto,Arial,sans-serif;}
    .wrap{max-width:1200px; margin:32px auto; padding:0 16px;}
    h1{font-size:20px; margin:0 0 10px}
    .sub{color:var(--muted); margin:0 0 20px; font-size:13px}
    .card{background:var(--panel); border:1px solid var(--grid); border-radius:14px; overflow:hidden; box-shadow:0 6px 30px rgba(0,0,0,.25)}
    table{width:100%; border-collapse:separate; border-spacing:0}
    thead th{background:rgba(255,255,255,.03); color:#cbd5e1; font-weight:600; text-align:left; padding:10px 12px; border-bottom:1px solid var(--grid)}
    tbody td{padding:10px 12px; border-bottom:1px solid var(--grid); vertical-align:middle}
    tbody tr:hover{background:rgba(255,255,255,.03)}
    code.small{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:12px; color:#cbd5e1}
    .muted{color:var(--muted)}
    .time-dim{color:var(--muted)}
    .right{float:right}
    .legend{display:flex; gap:10px; align-items:center; flex-wrap:wrap; color:var(--muted); font-size:12px; margin:10px 0 0}
    .pill{padding:.2rem .55rem; border-radius:999px; border:1px solid var(--badge-br); background:var(--badge-bg); color:var(--badge-fg); font-weight:600; font-size:12px; display:inline-block; white-space:nowrap}
    .badge{padding:.25rem .6rem; border-radius:999px; font-weight:600; border:1px solid transparent; font-size:12px; display:inline-block}
    .badge-ok{ background:var(--ok-bg); color:var(--ok-fg); border-color:var(--ok-br) }
    .badge-warn{ background:var(--warn-bg); color:var(--warn-fg); border-color:var(--warn-br) }
    .badge-danger{ background:var(--danger-bg); color:var(--danger-fg); border-color:var(--danger-br) }
    .belt{ background:var(--badge-bg); color:var(--badge-fg); border-color:var(--badge-br) }
    .flow{ background:#19305c; color:#cfe0ff; border-color:#35519a }
    .faded{opacity:.8}
    .topbar{display:flex; justify-content:space-between; align-items:center; gap:14px}
    .btn{background:#1c2b4a; color:#cfe0ff; border:1px solid #324267; padding:8px 12px; border-radius:10px; cursor:pointer}
    .btn:hover{filter:brightness(1.1)}
    .ts{color:#cfe0ff}
    a{color:var(--accent); text-decoration:none}
    a:hover{text-decoration:underline}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div>
        <h1>Bristol (BRS) Baggage Belt Allocations</h1>
        <p class="sub">Live scrape from FlightRadar24 via feeder. Columns show <strong>Scheduled → ETA</strong> and a colored delay badge.</p>
      </div>
      <div>
        <button id="refreshBtn" class="btn">Refresh now</button>
        <div class="legend">
          <span>Delay legend:</span>
          <span class="badge badge-ok">on time / early</span>
          <span class="badge badge-warn">+10 to +19</span>
          <span class="badge badge-danger">≥ +20</span>
        </div>
      </div>
    </div>

    <div class="sub">
      <span>Data file: <code class="small">docs/assignments.json</code></span>
      <span class="right">Last update: <span id="updatedAt" class="ts">—</span></span>
    </div>

    <div class="card">
      <table>
        <thead>
          <tr>
            <th>Flight</th>
            <th>Origin</th>
            <th>Time (Scheduled → ETA)</th>
            <th>Status</th>
            <th>Flow</th>
            <th>Belt</th>
            <th>Start</th>
            <th>End</th>
            <th>Reason</th>
          </tr>
        </thead>
        <tbody id="table-body">
          <tr><td colspan="9" class="muted">Loading…</td></tr>
        </tbody>
      </table>
    </div>

    <p class="sub faded" style="margin-top:12px;">
      Tip: If the page looks stale, press <strong>Ctrl+F5</strong> (hard refresh) or click <em>Refresh now</em>.
    </p>
  </div>

  <script>
    // -------- utility formatters --------
    function pad(n){ return String(n).padStart(2,'0'); }
    function hhmmFromIso(iso){
      try{
        const d = new Date(iso);
        return `${pad(d.getHours())}:${pad(d.getMinutes())}`;
      }catch{ return ""; }
    }
    function statusBadge(delayMin){
      if (typeof delayMin !== "number") return '<span class="badge badge-ok">on time</span>';
      if (delayMin <= 0) return '<span class="badge badge-ok">on time</span>';
      if (delayMin < 20) return `<span class="badge badge-warn">delayed +${delayMin}</span>`;
      return `<span class="badge badge-danger">delayed +${delayMin}</span>`;
    }
    function cleanIata(o){
      return (o || "").replace(/[()]/g,"");
    }

    // -------- render --------
    function renderRows(rows){
      const tbody = document.querySelector("#table-body");
      tbody.innerHTML = "";

      // sort by ETA ascending
      rows.sort((a,b) => new Date(a.eta) - new Date(b.eta));

      rows.forEach(r => {
        const schedLocal = r.scheduled_local || "";
        const etaLocal   = r.eta_local || hhmmFromIso(r.eta);
        const delayMin   = (typeof r.delay_min === "number") ? r.delay_min : null;

        const timeCell = schedLocal
          ? `<span class="time-dim">${schedLocal}</span> → <span>${etaLocal}</span>`
          : `<span>${etaLocal}</span>`;

        const statusCell = `<span title="${r.status || ''}">${statusBadge(delayMin)}</span>`;

        const startHHmm = r.start ? hhmmFromIso(r.start) : "";
        const endHHmm   = r.end   ? hhmmFromIso(r.end)   : "";

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${r.flight || ""}</td>
          <td>${cleanIata(r.origin_iata || r.origin || "")}</td>
          <td>${timeCell}</td>
          <td>${statusCell}</td>
          <td><span class="pill flow">${(r.flow || "").toUpperCase()}</span></td>
          <td><span class="pill belt">${r.belt ?? "-"}</span></td>
          <td>${startHHmm}</td>
          <td>${endHHmm}</td>
          <td>${r.reason || ""}</td>
        `;
        tbody.appendChild(tr);
      });

      if (rows.length === 0){
        const tr = document.createElement("tr");
        tr.innerHTML = `<td colspan="9" class="muted">No flights in window.</td>`;
        tbody.appendChild(tr);
      }
    }

    // -------- data fetch --------
    async function load(){
      const bust = Date.now(); // cache-buster
      const url = `assignments.json?nocache=${bust}`;
      const res = await fetch(url, { cache: "no-store" });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const data = await res.json();

      // Show updated time
      const updated = new Date(data.generated_at_local || data.generated_at_utc || Date.now());
      document.querySelector("#updatedAt").textContent =
        `${updated.getFullYear()}-${pad(updated.getMonth()+1)}-${pad(updated.getDate())} ${pad(updated.getHours())}:${pad(updated.getMinutes())}`;

      renderRows(Array.isArray(data.rows) ? data.rows : []);
    }

    // wire up manual refresh + auto poll (optional)
    document.getElementById("refreshBtn").addEventListener("click", () => {
      load().catch(err => alert("Refresh failed: " + err.message));
    });

    // Initial load
    load().catch(err => {
      const tbody = document.querySelector("#table-body");
      tbody.innerHTML = `<tr><td colspan="9" class="muted">Failed to load data: ${err.message}</td></tr>`;
    });

    // (Optional) auto-refresh every 60s so the page catches new assignments.json pushes.
    // Change 60000 to 0 to disable.
    setInterval(() => {
      load().catch(() => {});
    }, 60000);
  </script>
</body>
</html>
