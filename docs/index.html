<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>BRS – Arrivals Belt Plan</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#0f1720; --panel:#111923; --ink:#e7edf5; --muted:#9fb1c5; --grid:rgba(255,255,255,.05);
      --green:#b7f3c8; --green-bg:#133d29;
      --blue:#a8d8ff; --blue-bg:#10314a;
      --orange:#ffe1b3; --orange-bg:rgba(255,212,154,.16);
      --red:#ffb3b8; --red-bg:#3d151a;
      --gold:#ffd34d; --gold-bg:#3b2f0a;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.4 system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial}
    header{padding:14px 16px;border-bottom:1px solid var(--grid);display:flex;justify-content:space-between;align-items:baseline;gap:1rem}
    h1{margin:0;font-size:18px;font-weight:700}
    .meta{color:var(--muted);font-size:12px;white-space:nowrap}

    .wrap{padding:10px 14px 26px}
    table{width:100%;border-collapse:collapse;background:var(--panel);border:1px solid rgba(255,255,255,.04);border-radius:8px;overflow:hidden}
    thead th{text-align:left;font-weight:600;color:var(--muted);font-size:11px;letter-spacing:.25px;text-transform:uppercase;padding:9px 10px;border-bottom:1px solid rgba(255,255,255,.03);background:rgba(0,0,0,.05);white-space:nowrap}
    tbody td{padding:7px 10px;border-bottom:1px solid rgba(255,255,255,.02);vertical-align:middle;font-size:13.5px}
    tbody tr:last-child td{border-bottom:0}
    .col-flight{width:8.5ch;font-weight:600}
    .col-origin{width:19ch}
    .col-time{width:16ch}
    .col-status{width:12ch}
    .col-flow{width:9ch}
    .col-belt{width:6ch}
    .col-start,.col-end{width:7ch;font-variant-numeric:tabular-nums}
    .origin-code{font-weight:600;display:block}
    .origin-name{font-size:12px;color:var(--muted);display:block;max-width:16ch;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .time{display:flex;gap:.35rem;align-items:center;font-variant-numeric:tabular-nums}
    .time-sched{opacity:.6}
    .time-arrow{opacity:.45}
    .time-eta{font-weight:600}

    .pill{display:inline-flex;align-items:center;justify-content:center;border-radius:999px;padding:.15rem .55rem;font-size:12.5px;white-space:nowrap;border:1px solid rgba(255,255,255,.09)}
    .pill-green{background:var(--green-bg);color:var(--green);border-color:rgba(183,243,200,.4)}
    .pill-blue{background:var(--blue-bg);color:var(--blue);border-color:rgba(168,216,255,.35)}
    .pill-orange{background:var(--orange-bg);color:var(--orange);border-color:rgba(255,212,154,.55)}
    .pill-red{background:var(--red-bg);color:var(--red);border-color:rgba(255,179,184,.4)}
    .pill-flow{background:rgba(16,25,50,.6);color:#dfe7ff}
    .pill-belt{background:rgba(19,22,30,.3);color:#e7edf5}
    .pill-grey{background:rgba(160,170,185,.12);color:#b8c2d1;border-color:rgba(184,194,209,.35)}
    .pill-gold{background:var(--gold-bg);color:var(--gold);border-color:rgba(255,211,77,.55);text-transform:uppercase;letter-spacing:.2px;box-shadow:inset 0 0 0 1px rgba(255,211,77,.25)}
    .pulse{animation:goldPulse 1.8s ease-in-out infinite}
    @keyframes goldPulse{
      0%{border-color:rgba(255,211,77,.25);box-shadow:inset 0 0 0 1px rgba(255,211,77,.2)}
      50%{border-color:rgba(255,211,77,.7);box-shadow:inset 0 0 0 1px rgba(255,211,77,.55)}
      100%{border-color:rgba(255,211,77,.25);box-shadow:inset 0 0 0 1px rgba(255,211,77,.2)}
    }

    tfoot td{color:var(--muted);font-size:12px;padding:6px 10px;text-align:right}
    .empty{text-align:center;padding:12px!important;color:var(--muted);font-size:13px}
    .error{color:#ffb3b8;background:rgba(61,21,26,.4);border:1px solid rgba(255,179,184,.4)}

    @media (max-width:980px){
      .col-reason{display:none}
      .col-start,.col-end{display:none}
      header{flex-wrap:wrap}
    }
  </style>
</head>
<body>
  <header>
    <h1>BRS – Arrivals Belt Plan</h1>
    <div class="meta" id="meta">Loading…</div>
  </header>
  <div class="wrap">
    <table>
      <thead>
        <tr>
          <th class="col-flight">Flight</th>
          <th class="col-origin">Origin</th>
          <th class="col-time">Time</th>
          <th class="col-status">Status</th>
          <th class="col-flow">Flow</th>
          <th class="col-belt">Belt</th>
          <th class="col-start">Start</th>
          <th class="col-end">End</th>
          <th class="col-reason">Reason</th>
        </tr>
      </thead>
      <tbody id="tbody">
        <tr><td colspan="9" class="empty">Loading…</td></tr>
      </tbody>
      <tfoot>
        <tr>
          <td colspan="9">Source: FR24 (screen-scrape) • This view refreshes when JSON updates.</td>
        </tr>
      </tfoot>
    </table>
  </div>
  <script>
    (async function(){
      const meta = document.querySelector('#meta');
      const tbody = document.querySelector('#tbody');

      // --- Robust fetch with simple fallbacks ---
      const candidates = [
        'assignments.json',
        './assignments.json',
        '/brs-belt-alloc/assignments.json'
      ];
      let data = null, lastError = null;
      for (const url of candidates){
        try{
          const res = await fetch(url + '?v=' + Date.now(), { cache:'no-store' });
          if(!res.ok) throw new Error('HTTP ' + res.status + ' on ' + url);
          const text = await res.text();
          data = JSON.parse(text);
          break;
        }catch(err){ lastError = err; }
      }
      if(!data){
        tbody.innerHTML = `<tr><td colspan="9" class="empty error">Could not load <code>assignments.json</code>. ${lastError? lastError.message:''}</td></tr>`;
        meta.textContent = 'Load failed';
        return;
      }

      const rawRows = Array.isArray(data.rows) ? data.rows : [];
      meta.textContent = `Generated ${data.generated_at_local || data.generated_at_utc || ''} • Horizon ${data.horizon_minutes || ''} min`;

      if(!rawRows.length){
        tbody.innerHTML = `<tr><td colspan="9" class="empty">No arrivals found (empty rows array).</td></tr>`;
        return;
      }

      // --- MINIMAL, SAFE TWEAKS: de-duplicate & stable order by best time key ---
      const rows = dedupeRows(rawRows);
      rows.sort((a,b) => timeKey(a) - timeKey(b));

      tbody.innerHTML = rows.map(r => renderRow(r)).join('');

      // ===== Helpers (kept tight & defensive) =====
      function escapeHtml(s){
        return String(s ?? '').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
      }
      function pad(n){ return String(n).padStart(2,'0'); }
      function hhmm(iso){
        if(!iso) return '';
        const d = new Date(iso);
        if (Number.isNaN(d.getTime())) return '';
        return `${pad(d.getHours())}:${pad(d.getMinutes())}`;
      }
      function parseLocalHHMM(hm){
        if(!hm) return null;
        const m = String(hm).match(/^(\d{1,2}):(\d{2})$/);
        if(!m) return null;
        const hh = +m[1], mm = +m[2];
        if(hh>23 || mm>59) return null;
        const now = new Date();
        const dt = new Date(now.getFullYear(), now.getMonth(), now.getDate(), hh, mm, 0, 0);
        return isNaN(dt.getTime()) ? null : dt;
      }
      function safeMs(dt){
        if(!dt) return Number.POSITIVE_INFINITY;
        const ms = dt.getTime();
        return Number.isNaN(ms) ? Number.POSITIVE_INFINITY : ms;
      }
      // primary sort key: ETA (ISO/local) → start → scheduled_local → Infinity
      function timeKey(r){
        const etaIso = r?.eta ? new Date(r.eta) : null;
        const etaLoc = r?.eta_local ? parseLocalHHMM(r.eta_local) : null;
        const start   = r?.start ? new Date(r.start) : null;
        const sched   = r?.scheduled_local ? parseLocalHHMM(r.scheduled_local) : null;

        const msEta = Math.min(safeMs(etaIso), safeMs(etaLoc));
        if (msEta !== Number.POSITIVE_INFINITY) return msEta;
        if (start)  { const s = safeMs(start); if (s !== Number.POSITIVE_INFINITY) return s; }
        if (sched)  { const s2 = safeMs(sched); if (s2 !== Number.POSITIVE_INFINITY) return s2; }
        return Number.POSITIVE_INFINITY;
      }

      // Prefer a record that actually has an ETA/landed over a purely scheduled duplicate
      function score(r){
        const s = String(r?.status||'').toLowerCase();
        let v = 0;
        if (s.includes('landed')) v += 3;
        const hasEta = Boolean(r?.eta) || (r?.eta_local && r.eta_local.trim());
        if (hasEta) v += 2;
        if (s.startsWith('estimated') || s.includes('estimated')) v += 1;
        return v;
      }
      function key(r){
        // flight code plus a coarse time anchor reduces false merges
        const f = String(r?.flight||'').trim().toUpperCase();
        const sched = (r?.scheduled_local||'').trim();
        const etaL  = (r?.eta_local||'').trim();
        return sched ? `${f}__S:${sched}` : (etaL ? `${f}__E:${etaL}` : f);
      }
      function dedupeRows(list){
        const map = new Map();
        for (const r of list){
          const k = key(r);
          const cur = map.get(k);
          if (!cur) { map.set(k, r); continue; }
          // keep the "better" one; if tie, keep the one with the earlier timeKey
          const pick = (score(r) > score(cur)) ? r
                     : (score(r) < score(cur)) ? cur
                     : (timeKey(r) <= timeKey(cur) ? r : cur);
          map.set(k, pick);
        }
        return Array.from(map.values());
      }

      function beltBadge(b){
        const v = (b===undefined || b==="" || b===null) ? '?' : b;
        return `<span class="pill pill-belt">${v}</span>`;
      }
      function flowBadge(flow){
        return `<span class="pill pill-flow">${(flow||'').toUpperCase()}</span>`;
      }
      function timeCell(r){
        const etaLocal = r?.eta_local || hhmm(r?.eta);
        const schedLocal = r?.scheduled_local || '';
        if (schedLocal){
          return `<div class="time">
            <span class="time-sched">${escapeHtml(schedLocal)}</span>
            <span class="time-arrow">→</span>
            <span class="time-eta">${escapeHtml(etaLocal || '')}</span>
          </div>`;
        }
        return `<div class="time"><span class="time-eta">${escapeHtml(etaLocal || '')}</span></div>`;
      }

      function minutesToEta(r){
        if (!r || !r.eta) return null;
        const now = new Date();
        const eta = new Date(r.eta);
        if (Number.isNaN(eta.getTime())) return null;
        return Math.round((eta - now) / 60000);
      }
      function computeDeltaMin(r){
        if (typeof r?.delay_min === 'number' && !Number.isNaN(r.delay_min)) return r.delay_min;
        const schedDt = parseLocalHHMM(r?.scheduled_local);
        let etaDt = null;
        if (r?.eta_local) etaDt = parseLocalHHMM(r.eta_local);
        else if (r?.eta) {
          const d = new Date(r.eta);
          etaDt = Number.isNaN(d.getTime()) ? null : d;
        }
        if (!schedDt || !etaDt) return null;
        return Math.round((etaDt - schedDt) / 60000);
      }

      // status pill colours: landed→grey; finals (≤10m)→gold pulse; else by |Δ|
      function statusPill(r){
        const baseText = r?.status ? r.status : (r?.eta_local ? `Estimated ${r.eta_local}` : '—');
        const s = String(r?.status || '').toLowerCase();

        if (s.includes('landed')) {
          return `<span class="pill pill-grey">${escapeHtml(baseText)}</span>`;
        }

        const minsTo = minutesToEta(r);
        if (minsTo !== null && minsTo >= 0 && minsTo <= 10) {
          const finalsTime = r?.eta_local || hhmm(r?.eta);
          const txt = finalsTime ? `FINALS ${finalsTime}` : 'FINALS';
          return `<span class="pill pill-gold pulse">${escapeHtml(txt)}</span>`;
        }

        const hasEta = Boolean(r?.eta) || (r?.eta_local && r.eta_local.trim());
        if (!hasEta && s.startsWith('scheduled')) {
          return `<span class="pill pill-grey">${escapeHtml(baseText)}</span>`;
        }

        const d = computeDeltaMin(r);
        if (d === null) {
          return `<span class="pill pill-grey">${escapeHtml(baseText)}</span>`;
        }
        const abs = Math.abs(d);
        let cls = 'pill-green';                 // ≤4 → green
        if (abs >= 5 && abs <= 15) cls = 'pill-orange'; // 5–15 → light orange
        else if (abs > 15) cls = 'pill-red';            // >15 → red
        return `<span class="pill ${cls}">${escapeHtml(baseText)}</span>`;
      }

      function renderRow(r){
        return `
          <tr>
            <td class="col-flight">${escapeHtml(r.flight || '')}</td>
            <td class="col-origin">
              <span class="origin-code">${escapeHtml((r.origin_iata || '').toUpperCase())}</span>
              <span class="origin-name">${escapeHtml(r.origin || '')}</span>
            </td>
            <td class="col-time">${timeCell(r)}</td>
            <td class="col-status">${statusPill(r)}</td>
            <td class="col-flow">${flowBadge(r.flow || '')}</td>
            <td class="col-belt">${beltBadge(r.belt)}</td>
            <td class="col-start">${hhmm(r.start)}</td>
            <td class="col-end">${hhmm(r.end)}</td>
            <td class="col-reason">${escapeHtml(r.reason || '')}</td>
          </tr>
        `;
      }
    })();
  </script>
</body>
</html>
