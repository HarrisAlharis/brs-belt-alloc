<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>BRS – Baggage Belt Allocations</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #0f1720;
      --panel: #121a25;
      --ink: #e7edf5;
      --muted: #9fb1c5;
      --grid: rgba(255,255,255,0.06);
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      background: var(--bg);
      color: var(--ink);
      font: 14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    header {
      padding: 16px 20px;
      border-bottom: 1px solid var(--grid);
      display: flex; justify-content: space-between; align-items: baseline;
    }
    h1 { margin: 0; font-size: 20px; font-weight: 700; letter-spacing: .2px; }
    .meta { color: var(--muted); font-size: 12px; }

    .wrap { padding: 12px 16px 32px; }
    table { width: 100%; border-collapse: collapse; background: var(--panel); border: 1px solid var(--grid); border-radius: 10px; overflow: hidden; }
    thead th {
      text-align: left; font-weight: 600; color: var(--muted); font-size: 12px;
      padding: 10px 12px; border-bottom: 1px solid var(--grid);
      letter-spacing: .4px; text-transform: uppercase;
    }
    tbody td { padding: 12px; border-bottom: 1px solid var(--grid); vertical-align: middle; }
    tbody tr:last-child td { border-bottom: 0; }

    .col.flight { width: 10ch; font-weight: 700; }
    .col.origin { width: 22ch; }
    .origin-code { font-weight: 700; }
    .origin-name { color: var(--muted); font-size: 12px; }

    .col.eta { width: 18ch; }
    .time { display: inline-flex; align-items: center; gap: .35rem; }
    .time-sched { opacity: .75; }
    .time-arrow { opacity: .55; }
    .time-eta { font-weight: 700; }

    .pill {
      display: inline-flex; align-items: center; justify-content: center;
      border: 1px solid rgba(255,255,255,.15); border-radius: 999px;
      padding: .2rem .55rem; font-size: .85rem; white-space: nowrap;
    }
    .pill-green { background: #143b1f; color: #b7f3c8; border-color: #1f5a30; }
    .pill-orange { background: #3c2a10; color: #ffd49a; border-color: #835c2b; }
    .pill-red { background: #3e1316; color: #ffb3b8; border-color: #7a2a30; }
    .pill-blue { background: #102a3c; color: #a8d8ff; border-color: #2b587a; }

    .pill-flow { background:#101932; color:#dbe6ff; border-color:#2a3d7e; }
    .pill-belt { background:#1a1f2b; color:#d9deea; border-color:#30384a; min-width: 2.2rem; }

    .col.flow { width: 16ch; }
    .col.belt { width: 8ch; }
    .col.start, .col.end { width: 8ch; font-variant-numeric: tabular-nums; }
    .col.reason { color: var(--muted); }

    tfoot td { color: var(--muted); font-size: 12px; padding: 8px 12px; }
    .fade { opacity: .75; }
    .right { text-align: right; }
    .small { font-size: 12px; color: var(--muted); }
    @media (max-width: 920px) {
      .col.reason { display: none; }
    }
  </style>
</head>
<body>
  <header>
    <h1>BRS – Arrivals Belt Plan</h1>
    <div class="meta" id="meta"></div>
  </header>

  <div class="wrap">
    <table>
      <thead>
        <tr>
          <th>Flight</th>
          <th>Origin</th>
          <th>Time (local)</th>
          <th>Status</th>
          <th>Flow</th>
          <th>Belt</th>
          <th>Start</th>
          <th>End</th>
          <th>Reason</th>
        </tr>
      </thead>
      <tbody id="tbody">
        <tr><td colspan="9" class="small fade">Loading…</td></tr>
      </tbody>
      <tfoot>
        <tr>
          <td colspan="9" class="small right">Source: FR24 (screen-scrape) • This view refreshes when JSON updates.</td>
        </tr>
      </tfoot>
    </table>
  </div>

  <script>
    (async function(){
      const qs = (s, el=document)=>el.querySelector(s);

      // Cache-bust JSON so you see the latest pushed file.
      const res = await fetch(`assignments.json?v=${Date.now()}`);
      const data = await res.json();
      const rows = Array.isArray(data.rows) ? data.rows : [];

      // header meta
      const meta = qs('#meta');
      meta.textContent = `Generated ${data.generated_at_local || data.generated_at_utc || ''} • Horizon ${data.horizon_minutes || ''} min`;

      const tbody = qs('#tbody');
      tbody.innerHTML = rows.map(r => renderRow(r)).join('');

      // ---------- helpers ----------
      function pad(n){ return String(n).padStart(2,'0'); }
      function hhmm(iso){
        if(!iso) return '';
        const d = new Date(iso);
        return `${pad(d.getHours())}:${pad(d.getMinutes())}`;
      }
      function beltBadge(b){
        const v = (b===undefined || b==="" || b===null) ? '?' : b;
        return `<span class="pill pill-belt">${v}</span>`;
      }
      function flowBadge(flow){
        return `<span class="pill pill-flow">${(flow||'').toUpperCase()}</span>`;
      }
      function statusPill(r){
        // Priority: if JSON has numeric delay_min use it; else infer from status text.
        if (typeof r.delay_min === 'number') {
          if (r.delay_min >= 20) return pill(`+${r.delay_min}`, 'red');
          if (r.delay_min >= 10) return pill(`+${r.delay_min}`, 'orange');
          if (r.delay_min <= -1) return pill(`${r.delay_min}`, 'blue');
          return pill('on time', 'green');
        }
        const s = (r.status || '').toLowerCase();
        if (s.includes('delayed')) return pill(s, 'orange');       // no minutes available
        if (s.includes('estimated')) return pill(s, 'green');      // treat “estimated” as neutral/green
        if (s.includes('cancel')) return pill('cancelled', 'red');
        if (s.includes('landed') || s.includes('arrived')) return pill(s, 'blue');
        return pill(s || '—', 'green');
      }
      function pill(text, color){
        const cls = color==='red'?'pill-red':color==='orange'?'pill-orange':color==='blue'?'pill-blue':'pill-green';
        return `<span class="pill ${cls}">${escapeHtml(text)}</span>`;
      }
      function escapeHtml(s){
        return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
      }
      function timeCell(r){
        // If scheduled_local exists, show “scheduled → ETA”. Otherwise show ETA only.
        const etaLocal = r.eta_local || hhmm(r.eta);
        const schedLocal = r.scheduled_local || '';
        if (schedLocal) {
          return `<div class="time">
                    <span class="time-sched">${schedLocal}</span>
                    <span class="time-arrow">→</span>
                    <span class="time-eta">${etaLocal}</span>
                  </div>`;
        }
        return `<div class="time"><span class="time-eta">${etaLocal}</span></div>`;
      }
      function renderRow(r){
        return `
          <tr>
            <td class="col flight">${escapeHtml(r.flight||'')}</td>
            <td class="col origin">
              <div class="origin-code">${escapeHtml((r.origin_iata||'').toUpperCase())}</div>
              <div class="origin-name">${escapeHtml(r.origin||'')}</div>
            </td>
            <td class="col eta">${timeCell(r)}</td>
            <td class="col status">${statusPill(r)}</td>
            <td class="col flow">${flowBadge(r.flow||'')}</td>
            <td class="col belt">${beltBadge(r.belt)}</td>
            <td class="col start">${hhmm(r.start)}</td>
            <td class="col end">${hhmm(r.end)}</td>
            <td class="col reason">${escapeHtml(r.reason||'')}</td>
          </tr>
        `;
      }
    })();
  </script>
</body>
</html>
