<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>BRS Belt Allocations (Live)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#0b0f14; --card:#111823; --ink:#e7eef7; --muted:#a6b3c3;
      --ok:#17b26a; --warn:#f5a524; --bad:#ef4444; --cta:#7c3aed;
      --chip:#1b2430; --row:#0f1520; --row-alt:#111927; --grid:#233042;
      --badge:#0f1a2b;
    }
    html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font-family:system-ui,Segoe UI,Roboto,Inter,Arial,sans-serif}
    .wrap{max-width:1200px;margin:24px auto;padding:0 16px}
    h1{font-size:20px;margin:0 0 12px 0}
    .meta{color:var(--muted);font-size:12px;margin-bottom:16px}
    .controls{display:flex;gap:8px;align-items:center;margin-bottom:12px;color:var(--muted);font-size:13px;flex-wrap:wrap}
    .pill{display:inline-flex;align-items:center;gap:6px;background:var(--chip);border:1px solid var(--grid);padding:6px 10px;border-radius:999px}
    .pill b{color:var(--ink);font-weight:600}

    table{width:100%;border-collapse:separate;border-spacing:0 8px}
    thead th{font-size:12px;color:var(--muted);font-weight:600;text-align:left;padding:8px 10px}
    tbody tr{background:var(--row);box-shadow:0 1px 0 var(--grid) inset, 0 -1px 0 var(--grid) inset}
    tbody tr:nth-child(2n){background:var(--row-alt)}
    td{padding:10px;font-size:14px;vertical-align:middle}
    .flight{font-weight:700;letter-spacing:0.3px}
    .origin{color:var(--muted)}
    .eta{font-variant-numeric:tabular-nums}
    .status{font-weight:600}
    .belt{font-weight:700}
    .reason{color:var(--muted);font-size:12px}
    .badge{display:inline-block;padding:2px 8px;border-radius:999px;background:var(--badge);border:1px solid var(--grid)}
    .status.delayed{background:rgba(245,165,36,.12);color:var(--warn);border:1px solid rgba(245,165,36,.35)}
    .status.delayed-20{background:rgba(239,68,68,.12);color:var(--bad);border:1px solid rgba(239,68,68,.40)}
    .status.estimated{background:rgba(23,178,106,.12);color:var(--ok);border:1px solid rgba(23,178,106,.35)}
    .status.other{background:rgba(124,58,237,.12);color:var(--cta);border:1px solid rgba(124,58,237,.35)}

    .belt-chip{display:inline-flex;align-items:center;gap:6px;padding:2px 10px;border-radius:10px;border:1px solid var(--grid)}
    .belt-chip.intl{background:rgba(35,48,66,.5)}
    .belt-chip.dom{background:rgba(124,58,237,.18);border-color:rgba(124,58,237,.35)}
    .belt-chip.cta{background:rgba(52,211,153,.14);border-color:rgba(52,211,153,.35)}
    .belt-num{font-weight:800}

    .footer{margin-top:14px;color:var(--muted);font-size:12px}
    a{color:#8ab4ff;text-decoration:none}
    a:hover{text-decoration:underline}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>ðŸ§³ BRS Baggage Belt Allocations</h1>
    <div class="meta" id="meta">loadingâ€¦</div>

    <div class="controls">
      <span class="pill">Auto-refresh: <b id="refreshEvery">30s</b></span>
      <span class="pill">Source: <b>docs/assignments.json</b></span>
      <span class="pill">Legend:
        <span class="badge status estimated">Estimated</span>
        <span class="badge status delayed">Delayed &gt;10m</span>
        <span class="badge status delayed-20">Delayed &gt;20m</span>
      </span>
    </div>

    <table>
      <thead>
        <tr>
          <th>Flight</th>
          <th>Origin</th>
          <th>ETA (local)</th>
          <th>Status</th>
          <th>Flow</th>
          <th>Belt</th>
          <th>Start</th>
          <th>End</th>
          <th>Reason</th>
        </tr>
      </thead>
      <tbody id="rows"></tbody>
    </table>

    <div class="footer">
      Built from <code>docs/assignments.json</code>. Page reloads itself. Push new JSON to update.
    </div>
  </div>

<script>
const AUTO_REFRESH_MS = 30_000;

function fmtLocal(iso){
  if(!iso) return "";
  const d = new Date(iso);
  return d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit', hour12:false});
}

function parseDelayMinutes(status){
  if(!status) return null;
  const m = status.match(/\+(\d{1,3})\s?m/i);
  if(m) return parseInt(m[1], 10);
  return null;
}

function statusClass(status){
  const s = (status||"").toLowerCase();
  if(s.includes("delayed")){
    const mins = parseDelayMinutes(s);
    if (mins != null && mins >= 20) return "delayed-20";
    if (mins != null && mins >= 10) return "delayed";
    return "delayed";
  }
  if(s.includes("estimated")) return "estimated";
  return "other";
}

function flowClass(flow){
  const f = (flow||"").toUpperCase();
  if(f === "DOMESTIC") return "dom";
  if(f === "CTA") return "cta";
  return "intl";
}

async function loadAndRender(){
  const url = `assignments.json?ts=${Date.now()}`; // cache-bust
  const res = await fetch(url);
  if(!res.ok) throw new Error(`HTTP ${res.status}`);
  const data = await res.json();

  document.getElementById("meta").textContent =
    `Generated (UTC): ${data.generated_at_utc} â€¢ Local: ${data.generated_at_local} â€¢ Horizon: ${data.horizon_minutes} min â€¢ Rows: ${data.rows?.length ?? 0}`;

  const tbody = document.getElementById("rows");
  tbody.innerHTML = "";

  (data.rows || []).forEach(r => {
    const tr = document.createElement("tr");

    const tdFlight = document.createElement("td");
    tdFlight.className = "flight";
    tdFlight.textContent = r.flight || "";
    tr.appendChild(tdFlight);

    const tdOrigin = document.createElement("td");
    tdOrigin.innerHTML = `<div><b>${(r.origin_iata || "").toString()}</b></div><div class="origin">${(r.origin || "").toString()}</div>`;
    tr.appendChild(tdOrigin);

    const tdEta = document.createElement("td");
    tdEta.className = "eta";
    tdEta.textContent = fmtLocal(r.eta);
    tr.appendChild(tdEta);

    const tdStatus = document.createElement("td");
    const sBadge = document.createElement("span");
    sBadge.className = `badge status ${statusClass(r.status)}`;
    sBadge.textContent = (r.status || "").toString();
    tdStatus.appendChild(sBadge);
    tr.appendChild(tdStatus);

    const tdFlow = document.createElement("td");
    const fChip = document.createElement("span");
    fChip.className = `belt-chip ${flowClass(r.flow)}`;
    fChip.textContent = r.flow || "";
    tdFlow.appendChild(fChip);
    tr.appendChild(tdFlow);

    const tdBelt = document.createElement("td");
    const bChip = document.createElement("span");
    bChip.className = `belt-chip ${flowClass(r.flow)}`;
    bChip.innerHTML = `<span>Belt</span> <span class="belt-num">${r.belt ?? ""}</span>`;
    tdBelt.appendChild(bChip);
    tr.appendChild(tdBelt);

    const tdStart = document.createElement("td");
    tdStart.textContent = fmtLocal(r.start);
    tr.appendChild(tdStart);

    const tdEnd = document.createElement("td");
    tdEnd.textContent = fmtLocal(r.end);
    tr.appendChild(tdEnd);

    const tdReason = document.createElement("td");
    tdReason.className = "reason";
    tdReason.textContent = r.reason || "";
    tr.appendChild(tdReason);

    tbody.appendChild(tr);
  });
}

loadAndRender();
setInterval(() => { loadAndRender().catch(console.error); }, AUTO_REFRESH_MS);
</script>
</body>
</html>
