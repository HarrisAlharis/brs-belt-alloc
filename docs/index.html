<script>
(async function () {
  const meta = document.querySelector('#meta');
  const tbody = document.querySelector('#tbody');

  const candidates = [
    'assignments.json',
    './assignments.json',
    '/brs-belt-alloc/assignments.json'
  ];

  let data = null;
  let lastError = null;

  for (const url of candidates) {
    try {
      const res = await fetch(url + '?v=' + Date.now(), { cache: 'no-store' });
      if (!res.ok) throw new Error('HTTP ' + res.status + ' on ' + url);
      const text = await res.text();
      data = JSON.parse(text);
      break;
    } catch (err) {
      lastError = err;
    }
  }

  if (!data) {
    tbody.innerHTML = `<tr><td colspan="9" class="empty error">Could not load <code>assignments.json</code>. ${lastError ? lastError.message : ''}</td></tr>`;
    meta.textContent = 'Load failed';
    return;
  }

  const rowsRaw = Array.isArray(data.rows) ? data.rows : [];
  meta.textContent = `Generated ${data.generated_at_local || data.generated_at_utc || ''} • Horizon ${data.horizon_minutes || ''} min`;

  if (!rowsRaw.length) {
    tbody.innerHTML = `<tr><td colspan="9" class="empty">No arrivals found (empty rows array).</td></tr>`;
    return;
  }

  // === NEW: robust time key, dedupe by flight, keep a rolling window ===
  const snapshot = new Date(data.generated_at_local || data.generated_at_utc || Date.now());
  const now      = snapshot; // anchor to snapshot time for consistent ordering
  const pastTailMin = 90; // show last ~90 min for context
  const futureMin   = Number.isFinite(data.horizon_minutes) ? data.horizon_minutes : 180;

  function pad(n){ return String(n).padStart(2,'0'); }
  function hhmm(iso){
    if(!iso) return '';
    const d = new Date(iso);
    return `${pad(d.getHours())}:${pad(d.getMinutes())}`;
  }
  function escapeHtml(s){
    return String(s ?? '').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  }

  function parseHHMMonDate(hhmmStr, baseDate) {
    if (!hhmmStr) return null;
    const m = /^(\d{1,2}):(\d{2})$/.exec(hhmmStr.trim());
    if (!m) return null;
    const h = +m[1], mi = +m[2];
    return new Date(baseDate.getFullYear(), baseDate.getMonth(), baseDate.getDate(), h, mi, 0, 0);
  }

  // Prefer: ETA (ISO) → ETA (eta_local) → scheduled_local → start
  function timeKey(r) {
    if (r.eta) {
      const t = Date.parse(r.eta);
      if (!Number.isNaN(t)) return t;
    }
    if (r.eta_local) {
      const d = parseHHMMonDate(r.eta_local, snapshot);
      if (d) return +d;
    }
    if (r.scheduled_local) {
      const d = parseHHMMonDate(r.scheduled_local, snapshot);
      if (d) return +d;
    }
    if (r.start) {
      const t = Date.parse(r.start);
      if (!Number.isNaN(t)) return t;
    }
    return Number.POSITIVE_INFINITY;
  }

  // Rank: landed > has ETA > only scheduled
  function rank(r) {
    const s = String(r.status || '').toLowerCase();
    if (s.includes('landed')) return 3;
    if (r.eta || (r.eta_local && r.eta_local.trim())) return 2;
    return 1;
  }

  // Deduplicate by flight (keep the higher-ranked; if tie, keep later time)
  const byFlight = new Map();
  for (const r of rowsRaw) {
    const tk = timeKey(r);
    if (!Number.isFinite(tk)) continue;
    const prev = byFlight.get(r.flight);
    if (!prev) {
      byFlight.set(r.flight, { r, tk, rk: rank(r) });
    } else {
      if (rank(r) > prev.rk || (rank(r) === prev.rk && tk >= prev.tk)) {
        byFlight.set(r.flight, { r, tk, rk: rank(r) });
      }
    }
  }

  // Window: (now - 90m) .. (now + horizon)
  const minT = +now - pastTailMin * 60_000;
  const maxT = +now + futureMin   * 60_000;

  const rows = [...byFlight.values()]
    .map(x => ({ ...x.r, _tk: x.tk }))
    .filter(r => r._tk >= minT && r._tk <= maxT)
    .sort((a,b) => a._tk - b._tk);

  // === /NEW ===

  tbody.innerHTML = rows.map(r => renderRow(r)).join('');

  function beltBadge(b){
    const v = (b===undefined || b==="" || b===null) ? '?' : b;
    return `<span class="pill pill-belt">${v}</span>`;
  }
  function flowBadge(flow){
    return `<span class="pill pill-flow">${(flow||'').toUpperCase()}</span>`;
  }
  function timeCell(r){
    const etaLocal = r.eta_local || hhmm(r.eta);
    const schedLocal = r.scheduled_local || '';
    if (schedLocal) {
      return `<div class="time">
        <span class="time-sched">${escapeHtml(schedLocal)}</span>
        <span class="time-arrow">→</span>
        <span class="time-eta">${escapeHtml(etaLocal || '')}</span>
      </div>`;
    }
    return `<div class="time"><span class="time-eta">${escapeHtml(etaLocal || '')}</span></div>`;
  }

  function parseHHMMLocal(hhmmStr){
    return parseHHMMonDate(hhmmStr, snapshot);
  }
  function minutesToEta(r){
    if (!r || (!r.eta && !r.eta_local)) return null;
    const eta = r.eta ? new Date(r.eta) : parseHHMMonDate(r.eta_local, snapshot);
    if (!eta) return null;
    return Math.round((eta - snapshot) / 60000);
    }
  function computeDeltaMin(r){
    if (typeof r?.delay_min === 'number' && !Number.isNaN(r.delay_min)) return r.delay_min;
    const schedDt = parseHHMMonDate(r?.scheduled_local, snapshot);
    let etaDt = null;
    if (r?.eta_local) etaDt = parseHHMMonDate(r.eta_local, snapshot);
    else if (r?.eta) etaDt = new Date(r.eta);
    if (!schedDt || !etaDt) return null;
    return Math.round((etaDt - schedDt) / 60000);
  }

  // GOLD “FINALS” + lighter orange kept from your styles
  function statusPill(r){
    const baseText = r?.status ? r.status : (r?.eta_local ? `Estimated ${r.eta_local}` : '—');
    const s = String(r?.status || '').toLowerCase();

    if (s.includes('landed')) {
      return `<span class="pill pill-grey">${escapeHtml(baseText)}</span>`;
    }

    const minsTo = minutesToEta(r);
    if (minsTo !== null && minsTo >= 0 && minsTo <= 10) {
      const finalsTime = r?.eta_local || hhmm(r?.eta);
      const txt = finalsTime ? `FINALS ${finalsTime}` : 'FINALS';
      return `<span class="pill pill-gold pulse">${escapeHtml(txt)}</span>`;
    }

    const hasEta = Boolean(r?.eta || (r?.eta_local && r.eta_local.trim()));
    if (!hasEta && s.startsWith('scheduled')) {
      return `<span class="pill pill-grey">${escapeHtml(baseText)}</span>`;
    }

    const d = computeDeltaMin(r);
    if (d === null) {
      return `<span class="pill pill-grey">${escapeHtml(baseText)}</span>`;
    }
    const abs = Math.abs(d);
    let cls = 'pill-green';                     // ≤ 4 min
    if (abs >= 5 && abs <= 15) cls = 'pill-orange'; // 5–15
    else if (abs > 15) cls = 'pill-red';           // > 15
    return `<span class="pill ${cls}">${escapeHtml(baseText)}</span>`;
  }

  function renderRow(r){
    return `
      <tr>
        <td class="col-flight">${escapeHtml(r.flight || '')}</td>
        <td class="col-origin">
          <span class="origin-code">${escapeHtml((r.origin_iata || '').toUpperCase())}</span>
          <span class="origin-name">${escapeHtml(r.origin || '')}</span>
        </td>
        <td class="col-time">${timeCell(r)}</td>
        <td class="col-status">${statusPill(r)}</td>
        <td class="col-flow">${flowBadge(r.flow || '')}</td>
        <td class="col-belt">${beltBadge(r.belt)}</td>
        <td class="col-start">${hhmm(r.start)}</td>
        <td class="col-end">${hhmm(r.end)}</td>
        <td class="col-reason">${escapeHtml(r.reason || '')}</td>
      </tr>
    `;
  }
})();
</script>
