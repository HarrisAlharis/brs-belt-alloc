<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BRS — Arrivals Belt Plan</title>
  <style>
    :root{
      --bg:#0f1720; --panel:#121a24; --text:#d7e2ee; --muted:#89a0b5;
      --chip:#1b2836; --chip-on:#203142; --chip-border:#2a3e55;
      --row:#0f1720; --row-alt:#101c28; --line:#1e3044;
      --pill:#1e2a36; --pill-text:#dde9f6;
      --green:#18b26b; --orange:#e09938; --red:#ef4444; --blue:#50a7ff; --gold:#c9a227; --gold-soft:#ffe38a;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;background:var(--bg);color:var(--text);
      font:14px/1.45 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }
    .wrap{max-width:1400px;margin:0 auto;padding:20px}
    h1{margin:0 0 10px;font-size:20px}
    .meta{font-size:12px;color:var(--muted);text-align:right;margin-bottom:8px}
    .chips{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0 14px}
    .chip{
      background:var(--chip);border:1px solid var(--chip-border);color:var(--text);
      padding:6px 10px;border-radius:999px;cursor:pointer;user-select:none;
      font-size:12px;transition:background .2s, border-color .2s, opacity .2s;
    }
    .chip.on{background:var(--chip-on);border-color:#3b5576}
    .chip.off{opacity:.45}
    table{width:100%;border-collapse:collapse;background:var(--panel);border-radius:10px;overflow:hidden}
    thead{background:#0c141d}
    th,td{padding:10px 12px;border-bottom:1px solid var(--line);vertical-align:middle}
    th{font-size:12px;text-transform:uppercase;letter-spacing:.06em;color:#a7b6c6;text-align:left}
    tbody tr:nth-child(even){background:var(--row-alt)}
    .mono{font-variant-numeric:tabular-nums}
    .muted{color:var(--muted)}
    .pill{
      display:inline-block;border-radius:999px;padding:4px 8px;font-size:12px;
      background:var(--pill);color:var(--pill-text);
    }
    .pill.green{background:rgba(24,178,107,.14);color:#9df0c6;border:1px solid rgba(24,178,107,.35)}
    .pill.orange{background:rgba(224,153,56,.15);color:#ffd9a4;border:1px solid rgba(224,153,56,.35)}
    .pill.red{background:rgba(239,68,68,.14);color:#ffb4b4;border:1px solid rgba(239,68,68,.35)}
    .pill.blue{background:rgba(80,167,255,.14);color:#bfe0ff;border:1px solid rgba(80,167,255,.35)}
    .pill.grey{background:#1c2632;color:#b6c6d8;border:1px solid #2a394c}
    .pill.gold{
      position:relative;background:rgba(201,162,39,.15);color:#ffe8a6;border:1px solid rgba(201,162,39,.45)
    }
    .pill.gold::after{
      content:"";position:absolute;inset:-2px;border-radius:999px;border:2px solid rgba(255,232,134,.45);
      filter:blur(1px);animation:strobe 1.4s ease-in-out infinite;
    }
    @keyframes strobe{
      0%,100%{opacity:.25} 50%{opacity:.65}
    }
    .right{text-align:right}
    .center{text-align:center}
    .flight a{color:#8dc2ff;text-decoration:none}
    .flight a:hover{text-decoration:underline}
    .src-note{margin-top:8px;color:var(--muted);font-size:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>BRS — Arrivals Belt Plan</h1>
    <div class="meta" id="meta">Loading…</div>

    <div class="chips">
      <div class="chip on" data-key="early">Early &gt;5m</div>
      <div class="chip on" data-key="estimated">Estimated / On-time</div>
      <div class="chip on" data-key="delayed">Delayed</div>
      <div class="chip on" data-key="scheduled">Scheduled only</div>
    </div>

    <table>
      <thead>
        <tr>
          <th>Flight</th>
          <th>Origin</th>
          <th class="center">Time</th>
          <th>Status</th>
          <th>Flow</th>
          <th class="center">Belt</th>
          <th class="center">Start</th>
          <th class="center">End</th>
          <th>Reason</th>
        </tr>
      </thead>
      <tbody id="rows">
        <tr><td colspan="9" class="center">Loading…</td></tr>
      </tbody>
    </table>

    <div class="src-note" id="srcNote"></div>
  </div>

  <script>
    const chipsEl = document.querySelector('.chips');
    const rowsEl  = document.getElementById('rows');
    const metaEl  = document.getElementById('meta');
    const srcNote = document.getElementById('srcNote');

    const active = { early:true, estimated:true, delayed:true, scheduled:true };
    let baseInfo = { generated_at_utc:null, horizon_minutes:180 };
    let allRows = [];

    const HHMM = s => /^\d{2}:\d{2}$/.test(s||"") ? s : null;

    function hhmmNear(baseISO, hhmm){
      if(!HHMM(hhmm)) return null;
      const base = new Date(baseISO);
      const [H,M] = hhmm.split(':').map(Number);
      const d = new Date(base);
      d.setHours(H, M, 0, 0);

      const horizon = (baseInfo.horizon_minutes||180)*60*1000;
      if (d.getTime() < base.getTime() - horizon/2) d.setDate(d.getDate()+1);
      if (d.getTime() > base.getTime() + horizon/2) d.setDate(d.getDate()-1);
      return d;
    }

    function categoryOf(r){
      if ((r.status||"").toLowerCase().startsWith("scheduled") || (!r.eta && r.status==="scheduled")) return "scheduled";
      const d = (typeof r.delay_min === "number") ? r.delay_min : null;
      if (d !== null){
        if (d <= -5) return "early";
        if (d >= 5)  return "delayed";
        return "estimated";
      }
      const s = (r.status||"").toLowerCase();
      if (s.startsWith("delayed")) return "delayed";
      if (s.startsWith("estimated")) return "estimated";
      return "estimated";
    }

    function statusPill(r){
      const s = (r.status||"").toLowerCase();
      const d = (typeof r.delay_min === "number") ? r.delay_min : null;

      // FINALS gold if ETA within 10 minutes from now
      let finals = false;
      if (r.eta){
        const eta = new Date(r.eta).getTime();
        const now = Date.now();
        finals = Math.abs(eta - now) <= 10*60*1000 && s.startsWith("estimated");
      }

      let cls="grey", text=r.status||"scheduled";
      if (finals){ cls="gold"; text = (r.eta_local||"").trim() ? `FINALS ${r.eta_local}` : "FINALS"; }
      else if (d !== null){
        if (d <= -15 || d >= 15) cls="red";
        else if (d <= -5 || d >= 5) cls="orange";
        else cls="green";
        if (s.startsWith("landed")) cls="green";
        if (s.startsWith("estimated") && d <= -5) cls="blue";
      } else if (s.startsWith("delayed")) cls="red";
      else if (s.startsWith("estimated")) cls="green";

      return `<span class="pill ${cls}">${text}</span>`;
    }

    function fmtTimePair(r){
      const a = HHMM(r.scheduled_local) ? r.scheduled_local : "—";
      const b = HHMM(r.eta_local) ? r.eta_local : (r.status==="scheduled"?"—":r.eta_local||"—");
      return `<span class="mono">${a}</span> &nbsp;→&nbsp; <strong class="mono">${b}</strong>`;
    }

    function sortKey(r){
      if (r.eta) return new Date(r.eta).getTime();
      const d = hhmmNear(baseInfo.generated_at_utc, r.scheduled_local);
      return d ? d.getTime() : Number.POSITIVE_INFINITY;
    }

    function tooltipText(r){
      const bits = [];
      if (r.airline)  bits.push(r.airline);
      if (r.aircraft) bits.push(r.aircraft);
      bits.push(`Sched ${r.scheduled_local||"—"}`);
      bits.push(`ETA ${r.eta_local||"—"}`);
      bits.push(`Flow ${r.flow||"—"}`);
      bits.push(`Belt ${r.belt ?? "—"}`);
      if (r.reason) bits.push(r.reason);
      return bits.join(" • ");
    }

    function render(){
      const filtered = allRows.filter(r => active[categoryOf(r)]);
      filtered.sort((a,b)=>sortKey(a)-sortKey(b));

      if (!filtered.length){
        rowsEl.innerHTML = `<tr><td colspan="9" class="center muted">No flights match current filters.</td></tr>`;
        return;
      }

      const html = filtered.map(r=>{
        const originLabel = `${r.origin?.replace(/\((\w{3})\)$/, (_,x)=>`<span class="muted">(${x})</span>`) || "—"}`;
        return `<tr>
          <td class="flight"><a title="${tooltipText(r)}">${r.flight||"—"}</a></td>
          <td>${originLabel}</td>
          <td class="center">${fmtTimePair(r)}</td>
          <td>${statusPill(r)}</td>
          <td>${r.flow||"—"}</td>
          <td class="center mono">${r.belt ?? "—"}</td>
          <td class="center mono">${HHMM(r.start_local||"") ? r.start_local : (r.start? new Date(r.start).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}) : "—")}</td>
          <td class="center mono">${HHMM(r.end_local||"") ? r.end_local : (r.end? new Date(r.end).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}) : "—")}</td>
          <td>${r.reason||"—"}</td>
        </tr>`;
      }).join("");

      rowsEl.innerHTML = html;
    }

    // chip clicks
    chipsEl.addEventListener('click', (e)=>{
      const el = e.target.closest('.chip'); if(!el) return;
      const key = el.dataset.key;
      active[key] = !active[key];
      el.classList.toggle('on', active[key]);
      el.classList.toggle('off', !active[key]);
      render();
    });

    async function boot(){
      const res = await fetch('./assignments.json', {cache:'no-store'});
      const data = await res.json();
      baseInfo.generated_at_utc = data.generated_at_utc || data.generated_at_local || new Date().toISOString();
      baseInfo.horizon_minutes  = data.horizon_minutes || 180;

      metaEl.textContent = `Generated ${data.generated_at_utc} • Horizon ${baseInfo.horizon_minutes} min`;
      srcNote.textContent = `Source: ${data.source || 'FR24'} • Toggle chips: Early/Estimated/Delayed/Scheduled • Sorted by ETA (then scheduled).`;

      // normalise rows lightly (no unrelated changes)
      allRows = (data.rows||[]).map(r=>{
        // compute start_local/end_local for display if not present
        const toHHMM = d => d ? new Date(d).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}) : "";
        return {
          ...r,
          start_local: r.start_local || toHHMM(r.start),
          end_local:   r.end_local   || toHHMM(r.end)
        };
      });

      render();
    }

    boot().catch(err=>{
      rowsEl.innerHTML = `<tr><td colspan="9" class="center">Error loading data.</td></tr>`;
      console.error(err);
    });
  </script>
</body>
</html>
